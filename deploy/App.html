<!DOCTYPE html>
<html>
<head>
    <title>featuref9291</title>

    <script type="text/javascript" src="/apps/2.0/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("FeatureTreeModel",{extend:"Ext.data.TreeModel",fields:[{name:"_ref",type:"string"},{name:"_type",type:"string"},{name:"Name",type:"string"},{name:"Project",type:"object"},{name:"State",type:"object"},{name:"PercentDoneByStoryCount",type:"double"},{name:"FormattedID",type:"string"},{name:"Owner",type:"object"},{name:"c_Customer",type:"string"},{name:"c_LaunchRisk",type:"object"},{name:"c_OriginalLaunch",type:"object"},{name:"c_TargetLaunch",type:"string"},{name:"Notes",type:"string"}]}),Ext.define("ProjectTreeModel",{extend:"Ext.data.TreeModel",fields:[{name:"_ref",type:"string"},{name:"Name",type:"string"}]}),Ext.define("HierarchicalRequirementTreeModel",{extend:"Ext.data.TreeModel",fields:[{name:"_ref",type:"string"},{name:"_type",type:"string"},{name:"Name",type:"string"},{name:"Project",type:"object"},{name:"ScheduleState",type:"string"},{name:"FormattedID",type:"string"},{name:"Owner",type:"object"},{name:"Notes",type:"string"}]});var featureProjectsColl=[],projectUserStoriesColl=[],userStoriesColl=[];Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",launch:function(){this._loadFeatures()},_loadFeatures:function(){var that=this,featureFilter=[{property:"State.Name",value:"Started"}];Ext.create("Rally.data.wsapi.Store",{model:"PortfolioItem/Feature",autoLoad:!0,filters:featureFilter,context:{project:this.getContext().getProject()._ref},fetch:["Name","Project","State","PercentDoneByStoryCount","FormattedID","Owner","c_LaunchRisk","c_OriginalLaunch","c_TargetLaunch","c_Customer","Notes","UserStories"]}).load().then({success:this._loadUserStories,scope:this}).then({success:function(userStories){that._createGrid(userStories)},failure:function(){console.log("Wrong")}})},_loadUserStories:function(features){var promises=[];return _.each(features,function(feature){var userStories=feature.get("UserStories");userStories.Count>0&&(userStories.store=feature.getCollection("UserStories"),promises.push(userStories.store.load()))}),Deft.Promise.all(promises)},_createGrid:function(userStories){var that=this,userStoryData=_.flatten(userStories);_.each(userStoryData,function(thisUserStory){var thisUserStoryData=thisUserStory.data,featureRecord=thisUserStoryData.Feature,projectRecord=thisUserStoryData.Project;if(null!==featureProjectsColl&&featureProjectsColl.length>0){var isPresent=!1;_.each(featureProjectsColl,function(thisFeatureProject){var thisFeatureProjectKey=thisFeatureProject.key;thisFeatureProjectKey&&thisFeatureProjectKey.FormattedID===featureRecord.FormattedID&&(projectUserStoriesColl=thisFeatureProject.value,isPresent=!0)}),isPresent?that._mapUserStoriesToProject(projectRecord,thisUserStoryData):(projectUserStoriesColl=[],userStoriesColl=[],that._mapUserStoriesToProject(projectRecord,thisUserStoryData),featureProjectsColl.push({key:featureRecord,value:projectUserStoriesColl}))}else that._mapUserStoriesToProject(projectRecord,thisUserStoryData),featureProjectsColl.push({key:featureRecord,value:projectUserStoriesColl})}),that._createFeatureTreeStore(_.flatten(featureProjectsColl))},_mapUserStoriesToProject:function(projectRecord,thisUserStoryData){if(null!==projectUserStoriesColl&&projectUserStoriesColl.length>0){var isPresent=!1;_.each(projectUserStoriesColl,function(thisProjectUserStory){var thisprojectUserStoryKey=thisProjectUserStory.key;thisprojectUserStoryKey&&thisprojectUserStoryKey._ref===projectRecord._ref&&(userStoriesColl=thisProjectUserStory.value,isPresent=!0)}),isPresent?userStoriesColl.push(thisUserStoryData):(userStoriesColl=[],userStoriesColl.push(thisUserStoryData),projectUserStoriesColl.push({key:projectRecord,value:userStoriesColl}))}else userStoriesColl.push(thisUserStoryData),projectUserStoriesColl.push({key:projectRecord,value:userStoriesColl})},_createFeatureTreeStore:function(flattenedFeatureProjectsColl){var featureRootNode=Ext.create("FeatureTreeModel",{Name:"Feature Root",text:"Feature Root",root:!0,expandable:!0,expanded:!0});this._createFeatureNodesWithProjects(featureRootNode,flattenedFeatureProjectsColl);var panelHeight=550,userStoryTreePanel=this._createFeatureTreePanelGrid(featureRootNode,panelHeight);this.add(userStoryTreePanel)},_createFeatureNodesWithProjects:function(featureRootNode,flattenedFeatureProjectsColl){var that=this;Ext.Array.each(flattenedFeatureProjectsColl,function(thisFlattenedFeatureProject){var thisFlattenedFeatureProjectKey=thisFlattenedFeatureProject.key,thisFlattenedFeatureProjectValue=thisFlattenedFeatureProject.value,featureTreeNode=that._createFeatureTreeNode(thisFlattenedFeatureProjectKey);Ext.Array.each(thisFlattenedFeatureProjectValue,function(thisProjectUserStory){var projectUserStoryTreeNode=that._createProjectUserStoryTreeNode(thisProjectUserStory.key),thisUserStoryCollectionObject=thisProjectUserStory.value,current=that;Ext.Array.each(thisUserStoryCollectionObject,function(currentUserStory){var userStoryTreeNode=current._createUserStoryTreeNode(currentUserStory);projectUserStoryTreeNode.appendChild(userStoryTreeNode)}),featureTreeNode.appendChild(projectUserStoryTreeNode)}),featureRootNode.appendChild(featureTreeNode)})},_createFeatureTreeNode:function(thisFeature){var noEntryText="--No Entry--",noOwnerText="--No Owner--",featureTreeNode=Ext.create("FeatureTreeModel",{_ref:thisFeature._ref,Name:thisFeature.Name,FormattedID:thisFeature.FormattedID,c_TargetLaunch:this._getFieldText(thisFeature.c_TargetLaunch,"--No Target--"),c_LaunchRisk:this._getFieldText(thisFeature.c_LaunchRisk,noEntryText),c_OriginalLaunch:this._getFieldText(thisFeature.c_OriginalLaunch,"--No Target--"),PercentDoneByStoryCount:thisFeature.PercentDoneByStoryCount,Project:this._getFieldText(thisFeature.Project._refObjectName,noEntryText),State:thisFeature.State?this._getFieldText(thisFeature.State._refObjectName,noEntryText):noEntryText,Owner:thisFeature.Owner?this._getFieldText(thisFeature.Owner._refObjectName,noEntryText):noOwnerText,c_Customer:this._getFieldText(thisFeature.c_Customer,noEntryText),Notes:thisFeature.Notes,leaf:"PortfolioItem/Feature"===thisFeature._type?!1:!0,expandable:"PortfolioItem/Feature"===thisFeature._type?!0:!1,expanded:!1});return featureTreeNode},_createProjectUserStoryTreeNode:function(thisProjectUserStory){var noEntryText="--No Entry--",noOwnerText="--No Owner--",projectUserStoryTreeNode=Ext.create("ProjectTreeModel",{_ref:thisProjectUserStory._ref,Name:thisProjectUserStory.Name,Owner:thisProjectUserStory.Owner?this._getFieldText(thisProjectUserStory.Owner._refObjectName,noEntryText):noOwnerText,Notes:thisProjectUserStory.Notes,expandable:"Project"===thisProjectUserStory._type?!0:!1,expanded:!1});return projectUserStoryTreeNode},_createUserStoryTreeNode:function(thisUserStory){var noEntryText="--No Entry--",noOwnerText="--No Owner--",userStoryTreeNode=Ext.create("HierarchicalRequirementTreeModel",{_ref:thisUserStory._ref,Name:thisUserStory.Name,FormattedID:thisUserStory.FormattedID,Project:this._getFieldText(thisUserStory.Project._refObjectName,noEntryText),ScheduleState:thisUserStory.ScheduleState,Owner:thisUserStory.Owner?this._getFieldText(thisUserStory.Owner._refObjectName,noEntryText):noOwnerText,Notes:thisUserStory.Notes,expandable:"HierarchicalRequirement"===thisUserStory._type?!0:!1});return userStoryTreeNode},_createFeatureTreePanelGrid:function(featureRootNode,panelHeight){var userStoryTreeStore=Ext.create("Ext.data.TreeStore",{model:"FeatureTreeModel",root:featureRootNode}),userStoryItemTreePanel=Ext.create("Ext.tree.Panel",{store:userStoryTreeStore,useArrows:!0,lines:!1,displayField:"FormattedID",rootVisible:!1,width:"100%",height:"auto",columns:[{xtype:"treecolumn",text:"ID",dataIndex:"FormattedID",width:100},{text:"Name",dataIndex:"Name",width:300},{text:"Project",dataIndex:"Project",width:150},{text:"State",dataIndex:"ScheduleState",width:100},{text:"Owner",dataIndex:"Owner",width:150}]});return userStoryItemTreePanel},_getFieldText:function(fieldValue,defaultValue){return _.isUndefined(fieldValue)||_.isNull(fieldValue)?defaultValue:fieldValue}});

            Rally.launchApp('CustomApp', {
                name:"featuref9291",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        
    </style>
</head>
<body>
</body>
</html>
